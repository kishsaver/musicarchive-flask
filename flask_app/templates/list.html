<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ç™»éŒ²ã—ãŸæ¥½æ›²ã®ä¸€è¦§</title>
    <style>
        /* ãƒ†ãƒ¼ãƒ–ãƒ«å…¨ä½“ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        table {
            border-collapse: collapse;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }
        th, td {
            border: 1px solid #000;
            padding: 8px 12px;
        }
        th {
            background-color: #e3f0fb;
            font-weight: bold;
        }
        /* ãƒœã‚¿ãƒ³å‘¨ã‚Šã®èª¿æ•´ */
        .button-group {
            margin: 20px 0;
        }
    </style>
    <script>
        function confirmDelete() {
            return confirm('é¸æŠã—ãŸæ¥½æ›²ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ');
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const audioElements = document.querySelectorAll("audio");
    
            audioElements.forEach(audio => {
                audio.addEventListener("play", function() {
                    const fileName = this.querySelector("source").src.split("/").pop(); // ãƒ•ã‚¡ã‚¤ãƒ«åå–å¾—
                    const playTime = new Date().toISOString(); // ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
    
                    fetch("{{ url_for('music.log_play_time') }}", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            play_timedate: playTime,
                            file_name: fileName
                        })
                    })
                    .then(response => response.json())
                    .then(data => console.log("Play logged:", data))
                    .catch(error => console.error("Error logging play:", error));
                });
            });
        });
    </script>
</head>
<body>
    <h1>ç™»éŒ²ã—ãŸæ¥½æ›²ã®ä¸€è¦§</h1>
    
    <div style="max-width: 800px; margin: 0 auto;">
    <!-- Flaskã§ã®ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èµ¤oré’ã§è¡¨ç¤º(errorã€success)-->
    {% with messages = get_flashed_messages(category_filter=["error"]) %}
        {% if messages %}
            {% for message in messages %}
                <p style="color: red;">{{ message }}</p>
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% with success_messages = get_flashed_messages(category_filter=["success"]) %}
        {% if success_messages %}
            {% for s_msg in success_messages %}
                <p style="color: blue;">{{ s_msg }}</p>
            {% endfor %}
        {% endif %}
    {% endwith %}

        <form method="POST" action="{{ url_for('music.list') }}" onsubmit="return confirmDelete();">
            <p>{{ login_user_id }}ã•ã‚“ãŒã“ã‚Œã¾ã§ç™»éŒ²ã—ãŸæ¥½æ›²</p>

            {% if musics %}
                <table>
                    <tr>
                        <th>é¸æŠ</th>
                        <th>æ¥½æ›²å</th>
                        <th>ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå</th>
                        <th>é©ã—ãŸã‚·ãƒ¼ãƒ³</th>
                        <th>BPM</th>
                        <th>å†ç”Ÿ</th>
                    </tr>
                    {% for music in musics %}
                    <tr>
                        <td align="center">
                            <input type="radio" name="music_id" value="{{ music.id }}">
                        </td>
                        <td>{{ music.song_name }}</td>
                        <td>{{ music.artist_name }}</td>
                        <td>{{ music.category }}</td>
                        <td>{{ music.bpm }}</td>
                        <td><audio controls><source src="{{ url_for('music.uploaded_file', file_name=music.file_name) }}"></audio></td>
                    </tr>
                    {% endfor %}
                </table>
                <div class="button-group">
                    <button type="submit" >
                        é¸æŠã—ãŸé …ç›®ã‚’å‰Šé™¤
                    </button>
                </div>
            {% else %}
                <p>æ¥½æ›²ãŒ1ä»¶ã‚‚ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
            {% endif %}
            <div class="button-group">
                <button type="button" onclick="location.href='{{ url_for('music.recorder') }}'">
                    æ¥½æ›²ã®ç™»éŒ²ã«æˆ»ã‚‹
                </button>
                <button type="button" onclick="location.href='{{ url_for('auth.logout') }}'">
                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                </button>
            </div>
        </form>
        <div>
            <button onclick="getMLRecommendation()">æ©Ÿæ¢°å­¦ç¿’ã§ãŠã™ã™ã‚</button>
            <p id="ml-recommendation-result"></p>
            
            <script>
                function getMLRecommendation() {
                    fetch("/analysis")
                        .then(response => response.json())
                        .then(data => {
                            if (data.message) {
                                document.getElementById("ml-recommendation-result").innerText = data.message;
                            } else {
                                document.getElementById("ml-recommendation-result").innerHTML = 
                                    `ğŸ¶ ãŠã™ã™ã‚ã®æ›²: ${data.song_name} (${data.artist_name}) [BPM: ${data.bpm}]`;
                            }
                        })
                        .catch(error => console.error("Error:", error));
                }
            </script>
        </div>
    </div>
</body>
</html>
